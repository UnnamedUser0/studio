/**
 * @fileoverview Firestore Security Rules for the Hermosillo Pizza Finder App.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user profiles and reviews, while providing public read access to pizzeria and testimonial data. Administrative privileges are granted based on an `isAdmin` flag in the user's profile. All write operations are strictly controlled based on authentication and role.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile data, accessible only to the authenticated user with matching UID. The `isAdmin` flag grants special privileges.
 * - /pizzerias/{pizzeriaId}: Stores pizzeria data, publicly readable but writable only by admins.
 * - /pizzerias/{pizzeriaId}/reviews/{reviewId}: Stores reviews for pizzerias, with ownership tied to the user who created the review. Admins can delete any review.
 * - /testimonials/{testimonialId}: Stores user testimonials, publicly readable, writable by authenticated users, and updatable/deletable by admins.
 *
 * Key Security Decisions:
 * - User listing is disallowed.
 * - Pizzeria and testimonial data is publicly readable.
 * - Admin privileges are determined by the `isAdmin` boolean in the user's own profile document. This is more secure and efficient than checking a separate collection.
 * - Reviews are secured to ensure that a review can only be created by the author, but can be deleted by the author or an admin.
 *
 * Denormalization for Authorization:
 * - The `isAdmin` property is stored directly on the user's profile, avoiding costly `get()` calls to other collections.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Enforces user-ownership for user profiles. Only the authenticated user can access their own profile. The `isAdmin` field cannot be changed by the user.
     * @path /users/{userId}
     * @allow (get, delete) User 'user_abc' can get or delete their profile at /users/user_abc.
     * @allow (create) A user can create their own profile.
     * @allow (update) A user can update their profile, but cannot make themselves an admin.
     * @deny (list) Listing users is not allowed.
     * @principle Enforces document ownership and prevents privilege escalation.
     */
    match /users/{userId} {
      allow get, delete: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id && !('isAdmin' in request.resource.data);
    }

    /**
     * @description Controls access to pizzeria data. Publicly readable, but only admins can create, update, or delete.
     * @path /pizzerias/{pizzeriaId}
     * @allow (get, list) Any user can read pizzeria data.
     * @allow (create, update, delete) Only admins can write to pizzerias.
     * @principle Public read access with admin-only writes.
     */
    match /pizzerias/{pizzeriaId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Enforces user-ownership for reviews. Only the author and admins can manage reviews.
     * @path /pizzerias/{pizzeriaId}/reviews/{reviewId}
     * @allow (get, list) Anyone can read reviews.
     * @allow (create) Any signed-in user can create a review for a pizzeria, linking it to their UID.
     * @allow (update) The review owner can update their own review.
     * @allow (delete) The review owner OR an admin can delete a review.
     * @principle Enforces document ownership for reviews, with admin moderation capability.
     */
    match /pizzerias/{pizzeriaId}/reviews/{reviewId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isReviewOwner(resource.data.userId) && resource != null;
      allow delete: if (isReviewOwner(resource.data.userId) || isAdmin()) && resource != null;
    }

    /**
     * @description Controls access to user testimonials. Publicly readable, authenticated users can create, and admins can update/delete.
     * @path /testimonials/{testimonialId}
     * @allow (get, list) Anyone can read testimonials.
     * @allow (create) Any signed-in user can create a testimonial.
     * @allow (update, delete) Only admins can update or delete testimonials.
     * @principle Public read, authenticated create, admin manage.
     */
    match /testimonials/{testimonialId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if isAdmin();
    }

    // --- Helper Functions ---

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * Checks if the currently authenticated user is an admin.
     * An admin is defined by having `isAdmin: true` in their user profile document.
     */
    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    function isReviewOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
    }
  }
}
